# Nix Darwin Kickstarter - Minimal

A basic configuration comprising essential settings for initiating nix-darwin. It can be safely deployed to your system.

## How to Use

1. Install Nix package manager via [Nix Official](https://nixos.org/download.html#nix-install-macos) or [DeterminateSystems/nix-installer](https://github.com/DeterminateSystems/nix-installer).
2. Read all the files in this `minimal` folder, and understand what they do.
   1. If you have trouble understanding, [ryan4yin/nixos-and-flakes-book](https://github.com/ryan4yin/nixos-and-flakes-book) is a good resource to learn nix and flakes.
3. Install Homebrew, see <https://brew.sh/>
   1. Homebrew is required to install most of the GUI apps, App Store's apps, and some CLI apps that are not available in nix's package repository `nixpkgs`.
4. Search `TODO` in this `minimal` folder, and complete all the TODOs.
5. Run the following command in the root of your nix configuration to start your nix-darwin journey(please change `hostname` to your hostname):

   ```bash
    nix build .#darwinConfigurations.MacBookPro.system \
   	--extra-experimental-features 'nix-command flakes'

   ./result/sw/bin/darwin-rebuild switch --flake .#MacBookPro``
   ```

To simplify the command, adding the following content by create a `Makefile` in the root of your nix configuration:

```makefile
# please change 'hostname' to your hostname
deploy:
	nix build .#darwinConfigurations.MacBookPro.system \
	   --extra-experimental-features 'nix-command flakes'

	./result/sw/bin/darwin-rebuild switch --flake .#MacBookPro
```

Then you can run `make deploy` in the root of your nix configuration to deploy your configuration.

## Configuration Structure

Your current nix-darwin configuration's structure should be as follows:

```bash
› tree
.
├── flake.lock  # a lock file generated by nix, you can ignore it for now
├── flake.nix   # the entry point of your nix configuration, you need to add your hostname here
├── modules     # a folder contains all your nix-darwin configuration files
│   ├── apps.nix        # contains all your homebrew & nix apps(both GUI & CLI)
│   ├── host-users.nix  # defines your hostname & all your system users
│   ├── nix-core.nix    # nix's core configuration, you can ignore it for now
│   └── system.nix      # defines your macOS's system configuration(like dock, trackpad, keyboard, finder, loginwindow, etc.)
└── README.md
```

## Notes on Network Proxy

If you are in a network environment that requires proxy(such as China), you may need to set up proxy for nix and homebrew.

Please refer to the `rich-demo` folder for more details:

- [rich-demo/scripts/darwin_set_proxy.py](/rich-demo/scripts/darwin_set_proxy.py)
- [rich-demo/Makefile](/rich-demo/Makefile)
- [rich-demo - homebrew's mirror settings](/rich-demo/modules/homebrew-mirror.nix)

## Hyprland-Dots (JaKooLit) – Integration über offnix-kool.nix

Diese Repo integriert JaKooLits Hyprland-Dots über das Home-Manager Modul `nix/home/offnix-kool.nix`. Ein vendorter Pfad unter `nix/vendor/hyprland-dots` wird automatisch bevorzugt, sonst wird das Flake-Input verwendet.

Vorgehen:
- Importiere `nix/home/offnix-kool.nix` in dein Home-Profile auf Hosts mit Hyprland.
- Optional: Lege die Dots unter `nix/vendor/hyprland-dots` ab; dieser Pfad wird automatisch verwendet, andernfalls das Flake-Input.

Rebuild:
- sudo nixos-rebuild switch --flake .#HOST
- oder: home-manager switch --flake .#USER

Nutzung im Home-Manager:
- Empfohlen: Importiere `nix/home/offnix-kool.nix` (deaktiviert HM’s Hyprland und verlinkt die Dots).

Was passiert:
- `offnix-kool.nix` verlinkt die Config-Verzeichnisse aus `Hyprland-Dots/config` nach `~/.config` (z. B. `hypr`, `waybar`, `rofi`, …).
- Falls `nix/vendor/hyprland-dots` existiert, wird dieser Pfad automatisch statt des Flake-Inputs verwendet.
- Laufzeitabhängigkeiten (rofi, waybar, hypr*-Tools, swww, Screenshots, Thunar, Papirus, …) werden als `home.packages` installiert.

Hinweise:
- KWallet wird automatisch installiert; systemweit ist PAM-Entsperren für SDDM/TTY aktiviert.
- Für KDE/Plasma ist die Tastaturbelegung “US intl” per plasma-manager konfiguriert (siehe `nix/home/nixos.nix`).

## Paket-Policy: Pakete platzieren und Duplikate vermeiden

Ziel: klare Zuständigkeiten, weniger Build-Zeit, keine Mehrfach-Installationen.

- Systemweit (NixOS)
  - Ort: `nix/hosts/common.nix` → `environment.systemPackages` (gemeinsam), plus host-spezifisch unter `nix/hosts/<host>/configuration.nix`.
  - Inhalt: nur, was wirklich systemweit gebraucht wird:
    - Treiber/Firmware (z. B. `broadcom-sta`), Systemservices, Display-Manager/Plasma-Komponenten.
    - Runtimes/Tray-Integrationen, die Sitzungen bereitstellen (z. B. `polkit_gnome`, `networkmanagerapplet`, `qt6.qtwayland`).
    - Host-spezifische Tools (z. B. VM-Tools, Druckertreiber).
  - Nicht systemweit: reine User-CLI-Tools (z. B. `ripgrep`, `fd`, `bat`, `eza`, `fzf`, `zoxide`, `jq`).

- Desktop/Hyprland
  - Systemmodul: `nix/hosts/hyprland.nix` definiert die Session (Hyprland, env vars, minimale Laufzeit-Tools).
  - Userseitig: Wayland-/Hyprland-Begleittools via Home Manager (siehe unten). Keine doppelte Installation systemweit UND im Home.

- Home Manager (Benutzer-Pakete)
  - Ort: `nix/home/core.nix` (CLI-Basics), profilspezifisch `nix/home/nixos.nix`, `nix/home/charly.nix`, `nix/home/vincent.nix`, etc.
  - Inhalt: User-CLI, LSPs, Formatter, Editoren, Wayland/Hyprland-Begleittools (rofi, waybar, wl-clipboard, grim, slurp, swappy, Thunar, …).
  - Hyprland-Dots:
    - Empfohlen: `nix/home/offnix-kool.nix` (verlinkt Dots, deaktiviert HM-Hyprland; bevorzugt vendorten Pfad, sonst Flake-Input)
    - Alternative: Standard-Hyprland via HM: `nix/home/hyprland.nix` (ohne externe Dots)

- Editor-Strategie
  - Bevorzugt: VSCodium über Home Manager (`programs.vscode.package = pkgs.vscodium;`).
  - Vermeiden: systemweites `vscode-fhs` (doppelt/unnötig) – stattdessen HM + Extensions.
  - Unfree vermeiden, wo möglich (VSCodium statt `code`). Falls doch nötig, gezielt whitelisten.

- Browser-Strategie
  - Entscheide dich systemweit für einen Browser (z. B. `firefox`) und vermeide Doppelungen (nicht zusätzlich `chromium`).

- Unfreie Pakete
  - Ort: `nix/hosts/common.nix` → `nixpkgs.config.allowUnfreePredicate`.
  - Halte die Liste minimal (z. B. `code`, `postman`, `discord`, `teamviewer`, `broadcom-sta`). Wenn du vollständig auf VSCodium umgestiegen bist, kann `code` später entfallen.

- Deduplizierungs-Checkliste (vor jedem Paket-Add)
  1. Suchen: Kommt das Paket bereits in `nix/**` vor?
  2. Entscheidung:
     - User-Tool → Home Manager (`nix/home/**`).
     - System-/Service-/Treiber-bezogen → systemweit (`nix/hosts/**`).
     - Desktop-Laufzeit (rofi/waybar/…): bevorzugt Home Manager.
  3. Keine Doppelinstallation (z. B. nicht gleichzeitig systemweit und im Home).
  4. Host-spezifisch? Dann ins passende `nix/hosts/<host>/configuration.nix`.
  5. Bei Dots: Entweder HM-Hyprland ODER Dots-Hyprland, nicht beides.

- Hinweise zur aktuellen Repo-Struktur (vereinheitlicht)
  - VSCode: auf VSCodium umgestellt (HM), `vscode-fhs` aus devnix entfernt.
  - Hyprland systemweit verschlankt; Wayland-/User-Tools in HM ausgelagert.
  - `wayvnc` in HM (nicht systemweit).
  - Browser: auf `firefox` vereinheitlicht.

- Testen/Prüfen
  - Flake prüfen/formatieren: `nix flake check`, `nix fmt`
  - Host bauen: `sudo nixos-rebuild switch --flake .#<host>`
  - HM anwenden: `home-manager switch --flake .#<user>@<host>`
